# Appwrite Group Chat Database Setup

**Date:** November 8, 2025  
**Database:** rpi_communication  
**Status:** ðŸ“‹ Planning & Implementation

---

## Overview

This guide implements a proper database structure for group chat functionality in Appwrite using dedicated collections for Groups, GroupMembers, and updated Messages schema.

**Benefits of Separate Collections:**

- âœ… Scalable architecture (groups can have unlimited members)
- âœ… Efficient queries (indexed lookups instead of array searches)
- âœ… Proper permission management (per-group access control)
- âœ… Easy member role management (admin/moderator/member)
- âœ… Group-level settings and metadata
- âœ… ACID compliance for group operations

---

## 1. Groups Collection Schema

**Collection ID:** `groups`  
**Purpose:** Store group information and metadata

### Fields

| Field          | Type     | Required | Index  | Notes                                              |
| -------------- | -------- | -------- | ------ | -------------------------------------------------- |
| `$id`          | String   | âœ…       | Unique | Auto-generated by Appwrite (document ID)           |
| `name`         | String   | âœ…       | -      | Group display name                                 |
| `description`  | String   | -        | -      | Group description                                  |
| `owner_id`     | String   | âœ…       | âœ…     | Reference to Users collection (creator)            |
| `group_type`   | String   | âœ…       | âœ…     | Type: "class", "department", "project", "interest" |
| `avatar_url`   | String   | -        | -      | Group profile picture URL                          |
| `member_count` | Integer  | -        | âœ…     | Denormalized count for quick display               |
| `is_active`    | Boolean  | âœ…       | âœ…     | Soft delete flag                                   |
| `created_at`   | DateTime | âœ…       | âœ…     | Creation timestamp                                 |
| `updated_at`   | DateTime | âœ…       | -      | Last update timestamp                              |
| `metadata`     | Object   | -        | -      | Custom fields (JSON object)                        |

### Indexes

```
1. owner_id (ASC) - Query groups by owner
2. group_type (ASC) - Filter by group type
3. is_active (ASC) - Query active groups only
4. created_at (DESC) - Sort groups by creation date
```

### Permissions

```json
{
  "read": ["role:authenticated", "team:group_$groupId_members"],
  "create": ["role:authenticated"],
  "update": ["user:$ownerId"],
  "delete": ["user:$ownerId"]
}
```

**Permission Explanation:**

- Anyone authenticated can read groups
- Group members can read via team membership
- Only group owner can update/delete

---

## 2. GroupMembers Collection Schema

**Collection ID:** `group_members`  
**Purpose:** Track user membership and roles in groups

### Fields

| Field          | Type     | Required | Index  | Notes                                            |
| -------------- | -------- | -------- | ------ | ------------------------------------------------ |
| `$id`          | String   | âœ…       | Unique | Format: `group_{groupId}_user_{userId}`          |
| `group_id`     | String   | âœ…       | âœ…     | Reference to Groups collection                   |
| `user_id`      | String   | âœ…       | âœ…     | Reference to Users collection                    |
| `role`         | String   | âœ…       | âœ…     | Values: "admin", "moderator", "member"           |
| `nickname`     | String   | -        | -      | Member's display name in group                   |
| `status`       | String   | âœ…       | âœ…     | Values: "active", "muted", "blocked", "inactive" |
| `joined_at`    | DateTime | âœ…       | -      | When user joined the group                       |
| `last_seen_at` | DateTime | -        | -      | Last activity timestamp                          |
| `unread_count` | Integer  | -        | -      | Unread messages in group                         |
| `metadata`     | Object   | -        | -      | Custom member settings                           |

### Indexes

```
1. group_id (ASC) - Get all members of a group
2. user_id (ASC) - Get all groups of a user
3. role (ASC) - Query members by role
4. status (ASC) - Find active/muted members
5. joined_at (DESC) - Sort members by join date
```

### Permissions

```json
{
  "read": ["user:$userId", "team:group_$groupId_admins"],
  "create": ["user:$userId", "team:group_$groupId_admins"],
  "update": ["user:$userId", "team:group_$groupId_admins"],
  "delete": ["team:group_$groupId_admins"]
}
```

---

## 3. Messages Collection Updates

**Existing Collection:** `messages`  
**Changes:** Add group support fields

### New Fields to Add

| Field                 | Type    | Required | Index | Notes                                             |
| --------------------- | ------- | -------- | ----- | ------------------------------------------------- |
| `group_id`            | String  | -        | âœ…    | Reference to Groups collection (NULL for P2P)     |
| `is_group_message`    | Boolean | âœ…       | âœ…    | Flag for easy filtering                           |
| `sender_display_name` | String  | -        | -     | Sender's name at time of send (denormalized)      |
| `sender_photo_url`    | String  | -        | -     | Sender's avatar at time of send                   |
| `mention_ids`         | Array   | -        | -     | User IDs mentioned in message                     |
| `reply_to_message_id` | String  | -        | -     | Reference to message being replied to             |
| `reactions`           | Object  | -        | -     | Emoji reactions: `{"ðŸ˜€": ["userId1", "userId2"]}` |

### Updated Indexes

```
1. group_id (ASC) - Get messages in group
2. sender_id (ASC) - Get messages by sender
3. created_at (DESC) - Sort messages chronologically
4. is_group_message (ASC) - Filter group vs P2P
5. recipient_id (ASC) - Keep existing P2P index
```

### Updated Permissions

```json
{
  "read": [
    "user:$recipientId",
    "user:$senderId",
    "team:group_$groupId_members"
  ],
  "create": ["role:authenticated"],
  "update": ["user:$senderId"],
  "delete": ["user:$senderId", "team:group_$groupId_admins"]
}
```

---

## 4. Implementation Steps

### Step 1: Create Collections via Appwrite Console

1. Go to Appwrite Console â†’ Database â†’ rpi_communication
2. Click "Create Collection"

**For Groups Collection:**

```
Collection ID: groups
Enabled: Yes
```

3. Add fields (see schema above)
4. Add indexes (see indexes above)
5. Set permissions (see permissions above)

**For GroupMembers Collection:**

```
Collection ID: group_members
Enabled: Yes
```

6. Repeat steps 3-5 for GroupMembers

### Step 2: Update Messages Collection

1. Go to existing Messages collection
2. Add new fields: `group_id`, `is_group_message`, `sender_display_name`, etc.
3. Add new indexes
4. Update permissions to support group messages

### Step 3: Create Relationships (Optional)

Appwrite doesn't enforce foreign keys, but document the relationships:

```
Groups.owner_id â†’ Users.$id
GroupMembers.group_id â†’ Groups.$id
GroupMembers.user_id â†’ Users.$id
Messages.group_id â†’ Groups.$id (when group message)
Messages.sender_id â†’ Users.$id
```

---

## 5. Data Model Examples

### Create Group Example

```json
{
  "name": "CS 101 - Spring 2025",
  "description": "Classroom group for Computer Science 101",
  "owner_id": "user_12345",
  "group_type": "class",
  "avatar_url": "https://...",
  "member_count": 35,
  "is_active": true,
  "created_at": "2025-11-08T10:30:00.000Z",
  "updated_at": "2025-11-08T10:30:00.000Z",
  "metadata": {
    "semester": "Spring 2025",
    "department": "Computer Science",
    "max_members": 100
  }
}
```

### Add Member Example

```json
{
  "group_id": "group_001",
  "user_id": "user_12345",
  "role": "member",
  "nickname": "John Doe",
  "status": "active",
  "joined_at": "2025-11-08T10:35:00.000Z",
  "unread_count": 0,
  "metadata": {
    "muted": false,
    "notifications_enabled": true
  }
}
```

### Group Message Example

```json
{
  "group_id": "group_001",
  "sender_id": "user_12345",
  "recipient_id": "group_001",
  "is_group_message": true,
  "content": "Hello everyone!",
  "type": "text",
  "sender_display_name": "John Doe",
  "sender_photo_url": "https://...",
  "mention_ids": ["user_67890"],
  "reply_to_message_id": null,
  "reactions": {},
  "created_at": "2025-11-08T14:20:00.000Z",
  "read": true
}
```

---

## 6. Query Patterns

### Common Queries

**Get all groups for a user:**

```
SELECT * FROM group_members
WHERE user_id = "user_12345"
ORDER BY joined_at DESC
```

**Get all members in a group:**

```
SELECT * FROM group_members
WHERE group_id = "group_001"
ORDER BY joined_at ASC
```

**Get group messages:**

```
SELECT * FROM messages
WHERE group_id = "group_001" AND is_group_message = true
ORDER BY created_at DESC
LIMIT 50
```

**Get unread group messages:**

```
SELECT * FROM messages
WHERE group_id = "group_001" AND read = false
ORDER BY created_at DESC
```

---

## 7. Security Considerations

### Role-Based Access Control

- **Group Owner:** Can update group info, add/remove members, delete group
- **Group Admin:** Can add/remove members, moderate messages
- **Group Moderator:** Can moderate messages, mute members
- **Group Member:** Can read messages, send messages, view members

### Permission Patterns

Use Appwrite's team features:

- Create team: `group_{groupId}_members` - for all members
- Create team: `group_{groupId}_admins` - for admins only
- Add/remove users from teams as permissions change

### Message Permissions

```
Read: Any group member can read
Create: Any group member can send
Update: Only sender can edit
Delete: Sender or group admins
```

---

## 8. Performance Optimization

### Denormalization Strategy

For performance, denormalize these fields:

- `Messages.sender_display_name` - avoid joins on every message
- `Messages.sender_photo_url` - display sender avatar without extra query
- `Groups.member_count` - display count without aggregation query

### Caching Strategy

```
- Cache group info: 1 hour (invalidate on update)
- Cache group members: 15 minutes
- Cache message history: Until new message arrives
- Cache user's groups: 1 hour
```

### Batch Operations

```
- Fetch user's groups + unread counts: 1 query (with count)
- Fetch group info + member count: 1 query (denormalized)
- Fetch messages + sender info: 1 query (denormalized fields)
```

---

## 9. Implementation in Flutter

### Service Methods Overview

```dart
// GroupService methods
Future<String> createGroup(String name, String description, ...)
Future<void> addMember(String groupId, String userId, String role)
Future<void> removeMember(String groupId, String userId)
Future<List<GroupModel>> getUserGroups(String userId)
Future<GroupModel> getGroupDetails(String groupId)

// MessageService updates
Future<void> sendGroupMessage(String groupId, String content, ...)
Future<List<MessageModel>> getGroupMessages(String groupId, [int limit])
Future<void> markGroupMessagesAsRead(String groupId)

// GroupMemberService
Future<List<GroupMember>> getGroupMembers(String groupId)
Future<void> updateMemberRole(String groupId, String userId, String role)
```

---

## 10. Testing Checklist

- [ ] Create group via Appwrite console
- [ ] Add members to group
- [ ] Send message in group
- [ ] Verify members see message
- [ ] Check permissions work (non-members can't read)
- [ ] Update group info
- [ ] Remove member from group
- [ ] Test role-based permissions
- [ ] Performance test with 100+ members
- [ ] Test with offline messages

---

## 11. Next Steps

1. **Phase 1:** Create collections in Appwrite console
2. **Phase 2:** Implement GroupService in Flutter
3. **Phase 3:** Update MessageService for group support
4. **Phase 4:** Build GroupChatScreen UI
5. **Phase 5:** End-to-end testing
6. **Phase 6:** Deploy and monitor

---

## 12. References

- [Appwrite Database Documentation](https://appwrite.io/docs/databases)
- [Appwrite Collections & Documents](https://appwrite.io/docs/databases#collections)
- [Appwrite Permissions & Security](https://appwrite.io/docs/permissions)
- [Appwrite Teams & Roles](https://appwrite.io/docs/teams)
